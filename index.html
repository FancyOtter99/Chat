<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Login / Signup Screen -->
    <div id="auth-container">
        <h2>Login</h2>
        <input type="text" id="login-username" placeholder="Username">
        <input type="password" id="login-password" placeholder="Password">
        <button id="login-btn">Login</button>
        
        <h2>Sign Up</h2>
        <input type="text" id="signup-username" placeholder="Username">
        <input type="password" id="signup-password" placeholder="Password">
        <input type="email" id="signup-email" placeholder="Email">
        <button id="signup-btn">Sign Up</button>
    </div>
    <div id = "verify">
        <input type="text" id="verification-code" placeholder="Verification Code (Check Email)">
        <button id="verify-btn">Verify Email</button>
    </div>
        
    <!-- Chat Application -->
    <div id="chat-container" style="display: none;">
        <h2 id="username" class="username-hover">
            <span id="username-text"></span>
            <div class="tooltip" id="username-tooltip">Loading user info...</div>
        </h2>

        <div id="chat-windows">
            <!-- Group Chat -->
            <div id="group-chat">
                <h3>Group Chat</h3>
                <select id="group-room-switch">
                    <option value="general">General</option>
                    <option value="random">Minecraft</option>
                    <option value="help">Help</option>
                </select>
                <div id="group-chat-box"></div>
                <input type="text" id="group-message-input" placeholder="Type a message...">
                <button id="send-group-message">Send</button>
            </div>

            <!-- Private Chat -->
            <div id="private-chat">
                <h3>Private Chat</h3>
                <input type="text" id="private-chat-partner" placeholder="Enter username">
                <div id="private-chat-box"></div>
                <input type="text" id="private-message-input" placeholder="Type a message...">
                <button id="send-private-message">Send</button>
            </div>
        </div>
    </div>

    <script>
        Object.defineProperty(window, 'username', {
            get: function() {
                console.warn("Do not modify the username variable!");
                return username;
            },
            set: function() {
                console.warn("You can't change the username like that!");
            }
        });

        (function() {
            let username = "";
            let my_role = "";
            let socket = new WebSocket('wss://chat-aia5.onrender.com/ws');
            let bannedUsers = [];  // Array to store banned users
            document.getElementById('verify').style.display = 'none';
            // Wait for WebSocket connection to open
            socket.onopen = function() {
                console.log("WebSocket connection established!");
                alert('All applications are online');
            };

            // Login
            document.getElementById('login-btn').addEventListener('click', function() {
                let user = document.getElementById('login-username').value.trim();
                let pass = document.getElementById('login-password').value.trim();

                if (user && pass) {
                    socket.send(JSON.stringify({ type: "login", username: user, password: pass }));
                } else {
                    alert("Enter valid username and password.");
                }
            });
                let signupclicked = 0;
                
                // Sign Up
                document.getElementById('signup-btn').addEventListener('click', function() {
                    signupclicked++;
                    
                    if (signupclicked > 2) {
                        alert("You've tried signing up too many times. Calm down bro.");
                        return;
                    }
                
                    let user = document.getElementById('signup-username').value.trim();
                    let pass = document.getElementById('signup-password').value.trim();
                    let email = document.getElementById('signup-email').value.trim();
                
                    if (user && pass && email) {
                        socket.send(JSON.stringify({ type: "signup", username: user, password: pass, email: email }));
                        document.getElementById('auth-container').style.display = 'none';
                        document.getElementById('verify').style.display = 'block';
                        alert('Please verify your email by entering the code you were emailed into the input bar below. If you can’t find it, check your spam/junk folder.');
                    } else {
                        alert("Enter valid details.");
                    }
                });
            //verfy code
            document.getElementById('verify-btn').addEventListener('click', function() {
                let email = document.getElementById('signup-email').value.trim();  // <-- Send the email here
                let code = document.getElementById('verification-code').value.trim();
            
                if (email && code) {
                    socket.send(JSON.stringify({ type: "verify_code", email: email, code: code }));  // <-- Send email
                } else {
                    alert("Enter your email and the code.");
                }
            });
            
            // Listen for messages from the server
            socket.onmessage = function(event) {
                let data = JSON.parse(event.data);

                if (data.type === "login_success") {
                    document.getElementById('auth-container').style.display = 'none';
                    document.getElementById('verify').style.display = 'none';
                    document.getElementById('chat-container').style.display = 'block';
                    
                    const joinedDate = data.joined;
                    let daysJoined = "∞"; // Default to infinity if unknown
                    
                    if (joinedDate && joinedDate !== "1999-09-09") {
                        const joinDateObj = new Date(joinedDate);
                        const now = new Date();
                        const diffTime = Math.abs(now - joinDateObj);
                        daysJoined = Math.floor(diffTime / (1000 * 60 * 60 * 24)); // convert ms -> days
                    }
                    
                    document.getElementById('username').textContent = `Logged in as: ${data.username} (Joined ${daysJoined === "∞" ? "∞ days ago" : daysJoined + " days ago"})`;
                    //document.getElementById('username-tooltip').textContent = `sup`;

                    username = data.username;

                    // Disable input fields to prevent editing username after login
                    document.getElementById('login-username').disabled = true;
                    document.getElementById('signup-username').disabled = true;
                    Object.freeze(username);

                    if (my_role === "moderator") {
                        // Small remove/add admin button for mods only
                        const toggleAdminBtn = document.createElement('button');
                        toggleAdminBtn.id = 'toggle-admin-mode';
                        toggleAdminBtn.textContent = "Remove/Add Admin";
                        toggleAdminBtn.style.position = 'absolute';
                        toggleAdminBtn.style.top = '5px';
                        toggleAdminBtn.style.right = '10px';
                        toggleAdminBtn.style.width = '250px';
                        toggleAdminBtn.style.padding = '10px';
                        toggleAdminBtn.style.borderRadius = '5px';
                    
                        document.body.appendChild(toggleAdminBtn);
                            toggleAdminBtn.addEventListener('click', function () {
                            // Clear all inputs
                            document.querySelectorAll('#ban-bar input').forEach(input => input.value = '');
                    
                            const banSection = document.getElementById('ban-user');
                            const adminTools = document.getElementById('admin-tools');
                    
                            if (banSection.style.display === 'none') {
                                toggleAdminBtn.textContent = "Remove/Add Admin";
                                banSection.style.display = 'block';
                                adminTools.style.display = 'none';
                            } else {
                                toggleAdminBtn.textContent = "Ban/Unban";
                                banSection.style.display = 'none';
                                adminTools.style.display = 'flex';
                            }
                        });
                    }


                    if (my_role === "admin" || my_role === "moderator") {
                        // Create a new ban/unban bar
                        const banBar = document.createElement('div');
                        banBar.id = 'ban-bar';
                        banBar.style.position = 'absolute';
                        banBar.style.top = '65px';
                        banBar.style.right = '10px';
                        banBar.style.padding = '10px';
                        banBar.style.backgroundColor = '#ff6666';
                        banBar.style.color = '#fff';
                        banBar.style.borderRadius = '5px';
                        banBar.style.width = '250px';
                        banBar.innerHTML = `
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <div id="ban-user">
                                    <div>
                                        <span>Ban User:</span>
                                        <input type="text" id="ban-username" placeholder="Username">
                                        <button id="ban-btn">Ban</button>
                                    </div>
                                    <div>
                                        <span>Unban User:</span>
                                        <input type="text" id="unban-username" placeholder="Username">
                                        <button id="unban-btn">Unban</button>
                                    </div>
                                </div>
                                <div id="admin-tools" style="display: none; flex-direction: column; gap: 8px; margin-top: 10px;">
                                    <div>
                                        <span>Promote person</span>
                                        <input type="text" id="add-admin-username" placeholder="Username">
                                        <input type="text" id="role" placeholder="Role">
                                        <button id="add-admin-btn">Promote</button>
                                    </div>
                                    <div>
                                        <span>Demote person to noob</span>
                                        <input type="text" id="remove-admin-username" placeholder="Username">
                                        <button id="remove-admin-btn">Demote</button>
                                    </div>
                                </div>
                            </div>
                        `;

                        document.body.appendChild(banBar);

                        // Create a new banned list display
                        const bannedListBox = document.createElement('div');
                        bannedListBox.id = 'banned-list-box';
                        bannedListBox.style.position = 'absolute';
                        bannedListBox.style.top = '415px';
                        bannedListBox.style.right = '10px';
                        bannedListBox.style.width = '250px';
                        bannedListBox.style.backgroundColor = '#ffc107';
                        bannedListBox.style.padding = '10px';
                        bannedListBox.style.borderRadius = '5px';
                        bannedListBox.style.boxShadow = '0 0 10px rgba(0,0,0,0.2)';
                        bannedListBox.innerHTML = `
                           <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <button id="banned-list" style="flex:1;">Banned Users</button>
                                <button id="all-messages" style="flex:1;">All Messages</button>
                            </div>
                            <div id="tab-content">
                                <div id="banned-users-list">Loading...</div>
                                <div id="all-messages-tab" style="display:none;"></div>
                            </div>
                        `;
                        document.body.appendChild(bannedListBox);

                        

                        const currentUsername = username
                        // Optional: Hook up the buttons to your WebSocket logic
                        document.getElementById('add-admin-btn').addEventListener('click', function () {
                            const ausername = document.getElementById('add-admin-username').value.trim();
                            const role = document.getElementById('role').value.trim();
                            if (ausername) {
                                socket.send(JSON.stringify({
                                    type: 'admin-update',
                                    username: ausername,
                                    role: role,
                                    sender: currentUsername
                                }));
                            }
                        });
                        
                        document.getElementById('remove-admin-btn').addEventListener('click', function () {
                            const ausername = document.getElementById('remove-admin-username').value.trim();
                            if (ausername) {
                                socket.send(JSON.stringify({
                                    type: 'admin-remove',
                                    username: ausername,
                                    sender: currentUsername
                                }));
                            }
                        });


                        // Tab switching logic
                        document.getElementById('banned-list').addEventListener('click', function() {
                            document.getElementById('banned-users-list').style.display = 'block';
                            document.getElementById('all-messages-tab').style.display = 'none';
                        });

                        document.getElementById('all-messages').addEventListener('click', function() {
                            document.getElementById('banned-users-list').style.display = 'none';
                            document.getElementById('all-messages-tab').style.display = 'block';
                        });

                        // Update the banned users list from the server
                        fetchBannedUsers();

                        // Ban button
                        document.getElementById('ban-btn').addEventListener('click', function() {
                            const banUsername = document.getElementById('ban-username').value.trim();
                            if (banUsername) {
                                socket.send(JSON.stringify({ type: 'ban', username: banUsername, sender: username }));
                                // Fetch the updated banned list after banning a user
                                fetchBannedUsers();
                            } else {
                                alert("Enter a username to ban.");
                            }
                        });

                        // Unban button
                        document.getElementById('unban-btn').addEventListener('click', function() {
                            const unbanUsername = document.getElementById('unban-username').value.trim();
                            if (unbanUsername) {
                                socket.send(JSON.stringify({ type: 'unban', username: unbanUsername, sender: username }));
                                // Fetch the updated banned list after unbanning a user
                                fetchBannedUsers();
                            } else {
                                alert("Enter a username to unban.");
                            }
                        });

                        function updateBannedUsersList() {
                            const listDiv = document.getElementById('banned-users-list');
                            listDiv.innerHTML = bannedUsers.length > 0 ? bannedUsers.map(name => `<p>${name}</p>`).join('') : `<p>No users banned</p>`;
                        }

                        // Fetch banned users from the server
                        function fetchBannedUsers() {
                            fetch("https://chat-aia5.onrender.com/secret-banned-users?key=letmein")
                                .then(response => response.text())
                                .then(data => {
                                    bannedUsers = data.split("\n").filter(user => user.trim() !== "");
                                    updateBannedUsersList();
                                })
                                .catch(error => console.error("Error fetching banned users:", error));
                        }
                    }
                        const toggleAdmin = document.createElement('button');
                        toggleAdmin.id = 'turn-off-admin';
                        toggleAdmin.textContent = "Turn off Admin";
                        toggleAdmin.style.position = 'absolute';
                        toggleAdmin.style.top = '5px';
                        toggleAdmin.style.right = '1045px';
                        toggleAdmin.style.width = '250px';
                        toggleAdmin.style.padding = '10px';
                        toggleAdmin.style.borderRadius = '5px';
                    
                        document.body.appendChild(toggleAdmin);
                            toggleAdmin.addEventListener('click', function () {
                            // Clear all inputs
                            document.querySelectorAll('#ban-bar input').forEach(input => input.value = '');                            
                    
                            const banSection = document.getElementById('ban-bar');
                            const bannedpeople = document.getElementById('banned-list-box');
                            const switchbutton = document.getElementById('toggle-admin-mode');
                    
                            if (banSection.style.display === 'none') {
                                toggleAdmin.textContent = "Turn off Admin";
                                bannedpeople.style.display = 'block';
                                banSection.style.display = 'block';
                                switchbutton.style.display = 'block';
                            } else {
                                toggleAdmin.textContent = "Turn on Admin";
                                bannedpeople.style.display = 'none';
                                banSection.style.display = 'none';
                                switchbutton.style.display = 'none';
                            }
                        });
                    
                } else if (data.type === "group_message") {
                    let chatBox = document.getElementById('group-chat-box');
                    let room = document.getElementById('group-room-switch').value;

                    if (room === data.room) {
                        chatBox.innerHTML += `<p><strong>${data.sender}:</strong> ${data.message}</p>`;
                    }
                } else if (data.type === "private_message") {
                    let chatBox = document.getElementById('private-chat-box');
                    chatBox.innerHTML += `<p><strong>${data.sender}:</strong> ${data.message}</p>`;
                } else if (data.type === "private_message_copy") {
                    // Move private message copy to the "All Messages" tab
                    let allMessagesBox = document.getElementById('all-messages-tab');
                    allMessagesBox.innerHTML += `<p><strong>${data.original_sender} (to ${data.original_recipient}):</strong> ${data.message}</p>`;
                    console.log("Private message copy received from:", data.original_sender);
                } else if (data.type === "error") {
                    alert(data.message);
                }
                  else if (data.type === "role_info") {
                      my_role = data.role;
                      console.log(my_role);
                }
                  else if (data.type === "success") {
                      alert(data.message)
                }
            };
            // Handle WebSocket connection error
            socket.onerror = function(error) {
                console.error("WebSocket Error: ", error);
                alert("WebSocket connection error. Please reload page until it works.");
            };

            // Send group message
            document.getElementById('send-group-message').addEventListener('click', function() {
                let message = document.getElementById('group-message-input').value.trim();
                let room = document.getElementById('group-room-switch').value;

                if (message) {
                    socket.send(JSON.stringify({ type: "group_message", sender: username, room: room, message: message }));
                    document.getElementById('group-message-input').value = "";
                }
            });

            // Send private message
            document.getElementById('send-private-message').addEventListener('click', function() {
                let message = document.getElementById('private-message-input').value.trim();
                let recipient = document.getElementById('private-chat-partner').value.trim();

                if (message && recipient) {
                    socket.send(JSON.stringify({ type: "private_message", sender: username, recipient: recipient, message: message }));
                    document.getElementById('private-message-input').value = "";
                }
            });
        })();
    </script>

</body>
</html>
