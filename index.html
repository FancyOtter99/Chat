<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App</title>
    <link rel="stylesheet" href="style.css">
</head>
<body id="normal-content">
    <!-- Store Button -->
    <button id="store-btn">Store</button>

    <div id = "store-content">
        <div id = "item-one">
            <p>Pro. As a pro you can send people notifications. (30000 Chatterbucks)</p>
            <button id = "buy-item-one"> Buy Important Alert</button>
        </div>
        <div id = "item-two">
            <p>Edit cursor. (1000 Chatterbucks)</p>
            <button id = "buy-item-two"> Buy cursor styling</button>
        </div>
    </div>

    <!-- Login / Signup Screen -->
    <div id="auth-container">
        <h2>Login</h2>
        <input type="text" id="login-username" placeholder="Username">
        <input type="password" id="login-password" placeholder="Password">
        <button id="login-btn">Login</button>
        
        <h2>Sign Up</h2>
        <input type="text" id="signup-username" placeholder="Username">
        <input type="password" id="signup-password" placeholder="Password">
        <input type="email" id="signup-email" placeholder="Email">
        <button id="signup-btn">Sign Up</button>
    </div>
    <div id = "verify">
        <input type="text" id="verification-code" placeholder="Verification Code (Check Email)">
        <button id="verify-btn">Verify Email</button>
    </div>
        
    <!-- Chat Application -->
    <div id="chat-container" style="display: none;">
        <h2 id="username" class="username-hover">
            <span id="username-text"></span>
            <div class="tooltip" id="username-tooltip">Loading user info...</div>
        </h2>

        <div id="chat-windows">
            <!-- Group Chat -->
            <div id="group-chat">
                <h3>Group Chat</h3>
                <select id="group-room-switch">
                    <option value="general">General</option>
                    <option value="random">Minecraft</option>
                    <option value="help">Help</option>
                </select>
                <div id="group-chat-box"></div>
                <input type="text" id="group-message-input" placeholder="Type a message...">
                <button id="send-group-message">Send</button>
            </div>

            <!-- Private Chat -->
            <div id="private-chat">
                <h3>Private Chat</h3>
                <input type="text" id="private-chat-partner" placeholder="Enter username">
                <div id="private-chat-box"></div>
                <input type="text" id="private-message-input" placeholder="Type a message...">
                <button id="send-private-message">Send</button>
            </div>
        </div>
    </div>
</body>
</html>
    <script>
        Object.defineProperty(window, 'username', {
            get: function() {
                console.warn("Do not modify the username variable!");
                return username;
            },
            set: function() {
                console.warn("You can't change the username like that!");
            }
        });

        (function() {
            let items = {}
            let reward = ""
            let daysJoined = ""
            let new_Chatterbucks = ""
            let Chatterbucks = ""
            let pin = ""
            let color = ""
            let username = "";
            let my_role = "";
            let playGame = ""
            let socket = new WebSocket('wss://chat-aia5.onrender.com/ws');
            let bannedUsers = [];  // Array to store banned users
            const screenWidth = window.innerWidth;
            const buttonWidth = 250;
            const idealRight = 1045;
            const rightPosition = Math.min(idealRight, screenWidth - buttonWidth - 30);
            document.getElementById('verify').style.display = 'none';
            document.getElementById('store-btn').style.display = 'none';
            document.getElementById('store-content').style.display = 'none';
            // Wait for WebSocket connection to open
            socket.onopen = function() {
                console.log("WebSocket connection established!");
                alert('All applications are online');
            };

            // Send group message on Enter
            document.getElementById("group-message-input").addEventListener("keydown", function(event) {
                if (event.key === "Enter") {
                    event.preventDefault();
                    document.getElementById("send-group-message").click();
                }
            });
            
            // Send private message on Enter
            document.getElementById("private-message-input").addEventListener("keydown", function(event) {
                if (event.key === "Enter") {
                    event.preventDefault();
                    document.getElementById("send-private-message").click();
                }
            });


            function askNotificationPermission() {
                if (Notification.permission === "default") {
                    Notification.requestPermission().then(permission => {
                        if (permission === "granted") {
                            console.log("Notifications enabled!");
                        } else {
                            console.log("Notifications denied or dismissed.");
                        }
                    });
                }
            }

            function sendNotification(title, body) {
            if (Notification.permission === "granted") {
                new Notification(title, {
                    body: body,
                    icon: 'https://your-icon-url.com/icon.png', // Optional: add an icon for the notification
                    tag: 'chat-notification', // Optional: helps group notifications with the same tag
                });
            }
        }

            
            // Login
            document.getElementById('login-btn').addEventListener('click', function() {
                let user = document.getElementById('login-username').value.trim();
                let pass = document.getElementById('login-password').value.trim();

                if (user && pass) {
                    socket.send(JSON.stringify({ type: "login", username: user, password: pass }));
                } else {
                    alert("Enter valid username and password.");
                }
            });
                let signupclicked = 0;
                
                // Sign Up
                document.getElementById('signup-btn').addEventListener('click', function() {
                    signupclicked++;
                    
                    if (signupclicked > 2) {
                        alert("You've tried signing up too many times. Calm down bro.");
                        return;
                    }
                
                    let user = document.getElementById('signup-username').value.trim();
                    let pass = document.getElementById('signup-password').value.trim();
                    let email = document.getElementById('signup-email').value.trim();
                
                    if (user && pass && email) {
                        socket.send(JSON.stringify({ type: "signup", username: user, password: pass, email: email }));
                        document.getElementById('auth-container').style.display = 'none';
                        document.getElementById('verify').style.display = 'block';
                        alert('Please verify your email by entering the code you were emailed into the input bar below. If you can’t find it, check your spam/junk folder.');
                    } else {
                        alert("Enter valid details.");
                    }
                });
            //verfy code
            document.getElementById('verify-btn').addEventListener('click', function() {
                let email = document.getElementById('signup-email').value.trim();  // <-- Send the email here
                let code = document.getElementById('verification-code').value.trim();
            
                if (email && code) {
                    socket.send(JSON.stringify({ type: "verify_code", email: email, code: code }));  // <-- Send email
                } else {
                    alert("Enter your email and the code.");
                }
            });
            socket.addEventListener("message", (event) => {
                console.log("[RAW SOCKET DATA]", event.data);
            });

            // Listen for messages from the server
            socket.onmessage = function(event) {
                let data = JSON.parse(event.data);

                if (data.type === "login_success") {
                    document.getElementById('auth-container').style.display = 'none';
                    document.getElementById('verify').style.display = 'none';
                    document.getElementById('chat-container').style.display = 'block';
                    document.getElementById('store-btn').style.display = 'block';
                    const joinedDate = data.joined;
                    daysJoined = "∞"; // Default to infinity if unknown
                    askNotificationPermission()


                    sendNotification("log in", "thanks for logging in")
                    
                    if (joinedDate && joinedDate !== "1999-09-09") {
                        const joinDateObj = new Date(joinedDate);
                        const now = new Date();
                        const diffTime = Math.abs(now - joinDateObj);
                        daysJoined = Math.floor(diffTime / (1000 * 60 * 60 * 24)); // convert ms -> days
                    }
                    console.log(data.balance)
                    console.log(data.items)
                    items = data.items
                    if (data.items.includes("one")) {
                        const urgentalert = document.createElement('div');
                        urgentalert.id = 'urgent';
                        urgentalert.style.position = 'absolute';
                        urgentalert.style.top = '65px';
                        urgentalert.style.right = '10px';
                        urgentalert.style.padding = '10px';
                        urgentalert.style.backgroundColor = 'blue';
                        urgentalert.style.color = '#fff';
                        urgentalert.style.borderRadius = '5px';
                        urgentalert.style.width = '250px';
                        urgentalert.innerHTML = `<input id = 'alertmessage' style = "width: 200px; fontSize: 16px; padding: 10px; borderRadius: 5px;" placeholder = 'message'>
                        </input> <input id = 'alertusername' style = "width: 200px; fontSize: 16px; padding: 10px; borderRadius: 5px;" placeholder = 'who do you want to alert'>
                        </input> <button id = "startalert">Alert person</button>`


                        document.body.appendChild(urgentalert);
                        console.log("Blablabla granted. The 'one' is strong with this one.");
                    }
                    document.getElementById('username').textContent = `Logged in as: ${data.username}, Joined ${daysJoined === "∞" ? "∞ days ago" : `${daysJoined} days ago`}, Balance: ${data.balance} Chatterbucks`;
                    //document.getElementById('username-tooltip').textContent = `sup`;
                    Chatterbucks = data.balance

                    username = data.username;

                    // Disable input fields to prevent editing username after login
                    document.getElementById('login-username').disabled = true;
                    document.getElementById('signup-username').disabled = true;
                    Object.freeze(username);

                    if (my_role === "moderator") {
                        // Small remove/add admin button for mods only
                        const toggleAdminBtn = document.createElement('button');
                        toggleAdminBtn.id = 'toggle-admin-mode';
                        toggleAdminBtn.textContent = "Promote/Demote";
                        toggleAdminBtn.style.position = 'absolute';
                        toggleAdminBtn.style.top = '5px';
                        toggleAdminBtn.style.right = '10px';
                        toggleAdminBtn.style.width = '250px';
                        toggleAdminBtn.style.padding = '10px';
                        toggleAdminBtn.style.borderRadius = '5px';
                    
                        document.body.appendChild(toggleAdminBtn);
                            toggleAdminBtn.addEventListener('click', function () {
                            // Clear all inputs
                            document.querySelectorAll('#ban-bar input').forEach(input => input.value = '');
                    
                            const banSection = document.getElementById('ban-user');
                            const adminTools = document.getElementById('admin-tools');
                    
                            if (banSection.style.display === 'none') {
                                toggleAdminBtn.textContent = "Promote/Demote";
                                banSection.style.display = 'block';
                                adminTools.style.display = 'none';
                            } else {
                                toggleAdminBtn.textContent = "Ban/Unban";
                                banSection.style.display = 'none';
                                adminTools.style.display = 'flex';
                            }
                        });
                    }

                    if (my_role === "admin" || my_role === "moderator") {
                        // === Create the Game Selection Dropdown ===
                        const gameSelect = document.createElement('select');
                        gameSelect.id = 'game-select';
                        Object.assign(gameSelect.style, {
                            position: 'absolute',
                            top: '660px', // Above the Start Game button
                            right: '10px',
                            width: '250px',
                            padding: '10px',
                            borderRadius: '5px',
                            fontSize: '16px'
                        });
                    
                        const games = ['Maze', 'Trivia', 'Guess the Number', 'Dodgeball', 'Dance Off'];
                        games.forEach(game => {
                            const option = document.createElement('option');
                            option.value = game.toLowerCase().replace(/\s/g, '_'); // e.g. "guess_the_number"
                            option.textContent = game;
                            gameSelect.appendChild(option);
                        });
                    
                        document.body.appendChild(gameSelect);
                    
                        // === Create the Start Game Button ===
                        const startGameButton = document.createElement('button');
                        startGameButton.id = 'start-game-btn';
                        startGameButton.textContent = 'Start Game';
                        Object.assign(startGameButton.style, {
                            position: 'absolute',
                            top: '700px',
                            right: '10px',
                            width: '250px',
                            padding: '10px',
                            borderRadius: '5px',
                            backgroundColor: '#28a745',
                            color: '#fff',
                            fontWeight: 'bold',
                            cursor: 'pointer'
                        });
                    
                        document.body.appendChild(startGameButton);
                    
                        // === Event Listener to Start the Selected Game ===
                        startGameButton.addEventListener('click', function () {
                            const selectedGame = gameSelect.value;
                            alert(`Starting game: ${selectedGame}`);
                            if (selectedGame === "guess_the_number") {
                                pin = prompt('what is your 4 number pin')
                            }
                            socket.send(JSON.stringify({
                                type: 'start_game',
                                sender: username,
                                game: selectedGame,
                                pin: pin
                            }));
                        });
                    }
                    
                    if (my_role === "admin" || my_role === "moderator" || username ==="esrdctfvygubyuv564") {
                        // Create a new ban/unban bar
                        const banBar = document.createElement('div');
                        banBar.id = 'ban-bar';
                        banBar.style.position = 'absolute';
                        banBar.style.top = '65px';
                        banBar.style.right = '10px';
                        banBar.style.padding = '10px';
                        banBar.style.backgroundColor = '#ff6666';
                        banBar.style.color = '#fff';
                        banBar.style.borderRadius = '5px';
                        banBar.style.width = '250px';
                        banBar.innerHTML = `
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <div id="ban-user">
                                    <div>
                                        <span>Ban User:</span>
                                        <input type="text" id="ban-username" placeholder="Username">
                                        <button id="ban-btn">Ban</button>
                                    </div>
                                    <div>
                                        <span>Unban User:</span>
                                        <input type="text" id="unban-username" placeholder="Username">
                                        <button id="unban-btn">Unban</button>
                                    </div>
                                </div>
                                <div id="admin-tools" style="display: none; flex-direction: column; gap: 8px; margin-top: 10px;">
                                    <div>
                                        <span>Promote person</span>
                                        <input type="text" id="add-admin-username" placeholder="Username">
                                        <input type="text" id="role" placeholder="Role">
                                        <button id="add-admin-btn">Promote</button>
                                    </div>
                                    <div>
                                        <span>Demote person to noob</span>
                                        <input type="text" id="remove-admin-username" placeholder="Username">
                                        <button id="remove-admin-btn">Demote</button>
                                    </div>
                                </div>
                            </div>
                        `;

                        document.body.appendChild(banBar);

                        // Create a new banned list display
                        const bannedListBox = document.createElement('div');
                        bannedListBox.id = 'banned-list-box';
                        bannedListBox.style.position = 'absolute';
                        bannedListBox.style.top = '415px';
                        bannedListBox.style.right = '10px';
                        bannedListBox.style.width = '250px';
                        bannedListBox.style.backgroundColor = '#ffc107';
                        bannedListBox.style.padding = '10px';
                        bannedListBox.style.borderRadius = '5px';
                        bannedListBox.style.boxShadow = '0 0 10px rgba(0,0,0,0.2)';
                        bannedListBox.innerHTML = `
                           <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <button id="banned-list" style="flex:1;">Banned Users</button>
                                <button id="all-messages" style="flex:1;">All Messages</button>
                            </div>
                            <div id="tab-content">
                                <div id="banned-users-list">Loading...</div>
                                <div id="all-messages-tab" style="display:none;"></div>
                            </div>
                        `;
                        document.body.appendChild(bannedListBox);

                        

                        const currentUsername = username
                        // Optional: Hook up the buttons to your WebSocket logic
                        document.getElementById('add-admin-btn').addEventListener('click', function () {
                            const ausername = document.getElementById('add-admin-username').value.trim();
                            const role = document.getElementById('role').value.trim();
                            if (ausername) {
                                socket.send(JSON.stringify({
                                    type: 'admin-update',
                                    username: ausername,
                                    role: role,
                                    sender: currentUsername
                                }));
                            }
                        });
                        
                        document.getElementById('remove-admin-btn').addEventListener('click', function () {
                            const ausername = document.getElementById('remove-admin-username').value.trim();
                            if (ausername) {
                                socket.send(JSON.stringify({
                                    type: 'admin-remove',
                                    username: ausername,
                                    sender: currentUsername
                                }));
                            }
                        });


                        // Tab switching logic
                        document.getElementById('banned-list').addEventListener('click', function() {
                            document.getElementById('banned-users-list').style.display = 'block';
                            document.getElementById('all-messages-tab').style.display = 'none';
                        });

                        document.getElementById('all-messages').addEventListener('click', function() {
                            document.getElementById('banned-users-list').style.display = 'none';
                            document.getElementById('all-messages-tab').style.display = 'block';
                        });

                        // Update the banned users list from the server
                        fetchBannedUsers();

                        // Ban button
                        document.getElementById('ban-btn').addEventListener('click', function() {
                            const banUsername = document.getElementById('ban-username').value.trim();
                            if (banUsername) {
                                socket.send(JSON.stringify({ type: 'ban', username: banUsername, sender: username }));
                                // Fetch the updated banned list after banning a user
                                fetchBannedUsers();
                            } else {
                                alert("Enter a username to ban.");
                            }
                        });

                        // Unban button
                        document.getElementById('unban-btn').addEventListener('click', function() {
                            const unbanUsername = document.getElementById('unban-username').value.trim();
                            if (unbanUsername) {
                                socket.send(JSON.stringify({ type: 'unban', username: unbanUsername, sender: username }));
                                // Fetch the updated banned list after unbanning a user
                                fetchBannedUsers();
                            } else {
                                alert("Enter a username to unban.");
                            }
                        });

                        function updateBannedUsersList() {
                            const listDiv = document.getElementById('banned-users-list');
                            listDiv.innerHTML = bannedUsers.length > 0 ? bannedUsers.map(name => `<p>${name}</p>`).join('') : `<p>No users banned</p>`;
                        }

                        // Fetch banned users from the server
                        function fetchBannedUsers() {
                            fetch("https://chat-aia5.onrender.com/secret-banned-users?key=letmein")
                                .then(response => response.text())
                                .then(data => {
                                    bannedUsers = data.split("\n").filter(user => user.trim() !== "");
                                    updateBannedUsersList();
                                })
                                .catch(error => console.error("Error fetching banned users:", error));
                        }
                        const toggleAdmin = document.createElement('button');
                        toggleAdmin.id = 'turn-off-admin';
                        toggleAdmin.textContent = "Turn off Admin";
                        toggleAdmin.style.position = 'absolute';
                        toggleAdmin.style.top = '54px';
                        toggleAdmin.style.left = '186px';
                        //toggleAdmin.style.right = `${rightPosition}px`;
                        //toggleAdmin.style.right = '1045px';
                        toggleAdmin.style.width = '250px';
                        toggleAdmin.style.padding = '10px';
                        toggleAdmin.style.borderRadius = '5px';
                    
                        document.body.appendChild(toggleAdmin);
                        toggleAdmin.addEventListener('click', function () {
                            // Clear all inputs
                            document.querySelectorAll('#ban-bar input').forEach(input => input.value = '');                            
                        
                            const banSection = document.getElementById('ban-bar');
                            const bannedpeople = document.getElementById('banned-list-box');
                            const switchbutton = document.getElementById('toggle-admin-mode');
                        
                            if (banSection.style.display === 'none') {
                                toggleAdmin.textContent = "Turn off Admin";
                                bannedpeople.style.display = 'block';
                                banSection.style.display = 'block';
                                switchbutton.style.display = 'block';
                            } else {
                                toggleAdmin.textContent = "Turn on Admin";
                                bannedpeople.style.display = 'none';
                                banSection.style.display = 'none';
                                switchbutton.style.display = 'none';
                            }
                        });
                    }
                    
                } else if (data.type === "game_finished") {
                    alert(data.finisher + " finished the " + data.game + " game in " + data.time);
                    reward = prompt(`would you like to reward ${data.finisher} some Chatterbucks yes/no`)
                    if (reward === "yes") {
                        new_Chatterbucks = data.oldChatterbucks + 35;
                        socket.send(JSON.stringify({type: "addChatterbucks", username: data.finisher, amnt: new_Chatterbucks }))
                    }
                    
                }else if (data.type === "notify") {
                    console.log("Trying to notify", data);
                    sendNotification(`from ${data.sender}`, `${data.sender} says ${data.message}`)
                    console.log("notified")
                }
                
                else if (data.type === "addedChatterbucks") {
                    alert(`you now have ${data.amount} Chatterbucks in your account`)
                    Chatterbucks = data.amount
                    document.getElementById('username').textContent = `Logged in as: ${username}, Joined ${daysJoined === "∞" ? "∞ days ago" : `${daysJoined} days ago`}, Balance: ${data.balance} Chatterbucks`;
                }
                  else if (data.type === "pin_game_finished") {
                     alert(data.finisher + " finished the " + data.game + " game. the correct pin was " + data.correctPin);
                     document.getElementById('guess-box').style.display = 'none';
                    
                }

                
                  else if (data.type === "group_message") {
                    let chatBox = document.getElementById('group-chat-box');
                    let room = document.getElementById('group-room-switch').value;

                    if (room === data.room) {
                        chatBox.innerHTML += `<p><strong style="color: ${data.sentcolor}">${data.sender}:</strong> ${data.message}</p>`;
                    }
                } 
                
                  else if (data.type === "private_message") {
                    let chatBox = document.getElementById('private-chat-box');
                    chatBox.innerHTML += `<p><strong style="color: ${data.sentcolor}">${data.sender}:</strong> ${data.message}</p>`;
                } else if (data.type === "sender_message") {
                    let chatBox = document.getElementById('private-chat-box');
                    chatBox.innerHTML += `<p><strong>From you</strong> <strong>To ${data.original_recipient}:</strong> ${data.message}</p>`;
                }
                
                  else if (data.type === "private_message_copy") {
                    // Move private message copy to the "All Messages" tab
                    let allMessagesBox = document.getElementById('all-messages-tab');
                    allMessagesBox.innerHTML += `<p><strong>${data.original_sender} (to ${data.original_recipient}):</strong> ${data.message}</p>`;
                    console.log("Private message copy received from:", data.original_sender);
                } else if (data.type === "error") {
                    alert(data.message);
                }
                  else if (data.type === "role_info") {
                      my_role = data.role;
                      console.log(my_role);
                      const roleColors = {
                          moderator: "black",
                          admin: "red",
                          pro: "green",
                          middle: "blue",
                          plebe: "purple",
                          noob: "orange"
                      };
                      color = roleColors[my_role]
                }
                  else if (data.type === "success") {
                      alert(data.message)
                  }else if (data.type === "game_started") {
                    alert(data.message)
                    playGame = prompt(`Would you like to play the ${data.game} game to possibly get some Chatterbucks? yes/no`);
                    if (data.game === "maze") {
                        if (playGame === "yes") {
                          const gameOverlay = document.createElement('div');
                          const canvas = document.createElement('canvas');
                          const timerDisplay = document.createElement('div');
                        
                          document.body.appendChild(gameOverlay);
                          gameOverlay.appendChild(canvas);
                          gameOverlay.appendChild(timerDisplay);
                        
                          Object.assign(gameOverlay.style, {
                            position: 'fixed',
                            top: '0',
                            left: '0',
                            width: '100vw',
                            height: '100vh',
                            backgroundColor: 'black',
                            zIndex: '9999',
                            display: 'flex',
                            justifyContent: 'center',
                            alignItems: 'center',
                            flexDirection: 'column',
                          });
                        
                          Object.assign(canvas.style, {
                            backgroundColor: 'white',
                            border: '2px solid white',
                            cursor: 'crosshair',
                          });
                        
                          Object.assign(timerDisplay.style, {
                            color: 'white',
                            fontSize: '20px',
                            marginBottom: '10px',
                            fontFamily: 'monospace',
                          });
                        
                          canvas.width = 400;
                          canvas.height = 400;
                          const ctx = canvas.getContext('2d');
                        
                          const gridSize = 20;
                          const cols = canvas.width / gridSize;
                          const rows = canvas.height / gridSize;
                        
                          const startX = 0;
                          const startY = 0;
                          const goalX = cols - 2;
                          const goalY = rows - 2;
                        
                          let maze = Array.from({ length: rows }, () => Array(cols).fill(1));
                          let drawing = false;
                          let path = [];
                        
                          let startTime = null;
                          let timerInterval = null;
                        
                          function startTimer() {
                            startTime = Date.now();
                            timerInterval = setInterval(() => {
                              const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
                              timerDisplay.textContent = `Time: ${elapsed}s`;
                            }, 100);
                          }
                        
                          function stopTimer() {
                            clearInterval(timerInterval);
                          }
                        
                          function generateMaze() {
                            function shuffle(array) {
                              for (let i = array.length - 1; i > 0; i--) {
                                const j = Math.floor(Math.random() * (i + 1));
                                [array[i], array[j]] = [array[j], array[i]];
                              }
                            }
                        
                            function carve(x, y) {
                              const dirs = [[0, -2], [0, 2], [-2, 0], [2, 0]];
                              shuffle(dirs);
                              for (const [dx, dy] of dirs) {
                                const nx = x + dx, ny = y + dy;
                                if (ny >= 0 && ny < rows && nx >= 0 && nx < cols && maze[ny][nx] === 1) {
                                  maze[ny][nx] = 0;
                                  maze[y + dy / 2][x + dx / 2] = 0;
                                  carve(nx, ny);
                                }
                              }
                            }
                        
                            maze = Array.from({ length: rows }, () => Array(cols).fill(1));
                            maze[startY][startX] = 0;
                            carve(startX, startY);
                            maze[goalY][goalX] = 0;
                          }
                        
                          function drawMaze() {
                            for (let y = 0; y < rows; y++) {
                              for (let x = 0; x < cols; x++) {
                                if (maze[y][x] === 1) {
                                  ctx.fillStyle = 'black';
                                  ctx.fillRect(x * gridSize, y * gridSize, gridSize, gridSize);
                                }
                              }
                            }
                        
                            ctx.fillStyle = 'green';
                            ctx.fillRect(startX * gridSize, startY * gridSize, gridSize, gridSize);
                        
                            ctx.fillStyle = 'red';
                            ctx.fillRect(goalX * gridSize, goalY * gridSize, gridSize, gridSize);
                          }
                        
                          function redraw() {
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            drawMaze();
                            ctx.strokeStyle = 'blue';
                            ctx.lineWidth = 2;
                            ctx.beginPath();
                            for (let i = 0; i < path.length; i++) {
                              const [x, y] = path[i];
                              if (i === 0) ctx.moveTo(x, y);
                              else ctx.lineTo(x, y);
                            }
                            ctx.stroke();
                          }
                        
                          function handleWallHit() {
                            alert("You hit a wall or went out of bounds!");
                            drawing = false;
                            document.dispatchEvent(new MouseEvent('mouseup'));
                          }
                        
                          canvas.addEventListener('mousedown', (e) => {
                            const { offsetX, offsetY } = e;
                            const cellX = Math.floor(offsetX / gridSize);
                            const cellY = Math.floor(offsetY / gridSize);
                            if (cellX === startX && cellY === startY) {
                              drawing = true;
                              path = [[offsetX, offsetY]];
                              redraw();
                              if (!startTime) startTimer();
                            } else {
                              alert("Start on the green square!");
                            }
                          });
                        
                          canvas.addEventListener('mousemove', (e) => {
                            if (!drawing) return;
                            const { offsetX, offsetY } = e;
                            const cellX = Math.floor(offsetX / gridSize);
                            const cellY = Math.floor(offsetY / gridSize);
                        
                            // Out-of-bounds or outside white line
                            const edgePadding = 2;
                            if (
                              offsetX < edgePadding || offsetY < edgePadding ||
                              offsetX > canvas.width - edgePadding ||
                              offsetY > canvas.height - edgePadding
                            ) {
                              handleWallHit();
                              return;
                            }
                        
                            // Wall hit
                            if (maze[cellY]?.[cellX] === 1) {
                              handleWallHit();
                              return;
                            }
                        
                            path.push([offsetX, offsetY]);
                            redraw();
                        
                            if (cellX === goalX && cellY === goalY) {
                              stopTimer();
                              socket.send(JSON.stringify({ type: "finished_game", sender: username, oldchatterbucks: Chatterbucks, game: "maze", time: timerDisplay.textContent.split(' ')[1] }));
                              alert("🎉 Maze complete in " + timerDisplay.textContent.split(' ')[1] + "!");
                              gameOverlay.remove();
                            }
                          });
                        
                          canvas.addEventListener('mouseup', () => {
                            drawing = false;
                          });
                        
                          function resetGame() {
                            path = [];
                            drawing = false;
                            generateMaze();
                            drawMaze();
                            timerDisplay.textContent = 'Time: 0.00s';
                            clearInterval(timerInterval);
                            startTime = null;
                          }
                        
                          resetGame();
                        
    
                        }
                    }
                    else if (data.game === "guess_the_number") {
                        if (playGame === "yes") {
                            console.log('starting game')
                            // Create a new div for the guess box
                            let guessBox = document.createElement('div');
                            guessBox.id = 'guess-box';
                            guessBox.style.width = '240px';  // Slightly less wide
                            guessBox.style.padding = '20px';
                            guessBox.style.backgroundColor = 'white';
                            guessBox.style.borderRadius = '5px';
                            guessBox.style.boxShadow = '0px 0px 10px rgba(0, 0, 0, 0.1)';
                            guessBox.style.textAlign = 'center';
                            
                            // Position the box on the right side, slightly moved down and to the left
                            guessBox.style.position = 'fixed';  // or 'absolute' if you prefer
                            guessBox.style.top = '85.7%';  // Move it down a bit
                            guessBox.style.right = '10px';  // Move it 10px from the left edge
                            guessBox.style.transform = 'translateY(-50%)'; // Adjust for vertical centering
                            
                            // Create the input field
                            let inputField = document.createElement('input');
                            inputField.id = 'pin-guess';
                            inputField.type = 'text';
                            inputField.placeholder = '4 digit guess';
                            inputField.style.width = '80%';  // Stays at 100% of the parent (which is now narrower)
                            inputField.style.padding = '12px';
                            inputField.style.marginTop = '10px';
                            inputField.style.border = '1px solid #ccc';
                            inputField.style.borderRadius = '4px';
                            inputField.style.fontSize = '16px';
                            
                            // Create the button
                            let button = document.createElement('button');
                            button.id = 'guess-pin';
                            button.textContent = 'Submit Guess';
                            button.style.width = '90%';
                            button.style.padding = '12px';
                            button.style.marginTop = '15px';
                            button.style.backgroundColor = '#007bff';
                            button.style.color = 'white';
                            button.style.border = 'none';
                            button.style.borderRadius = '4px';
                            button.style.cursor = 'pointer';
                            button.style.fontSize = '16px';
                            
                            // Change the button color when hovered
                            button.addEventListener('mouseover', () => {
                                button.style.backgroundColor = '#0056b3';
                            });
                            button.addEventListener('mouseout', () => {
                                button.style.backgroundColor = '#007bff';
                            });
                            
                            // Append the input and button to the guess box
                            guessBox.appendChild(inputField);
                            guessBox.appendChild(button);
                            
                            // Append the guess box to the body (or any other container you prefer)
                            document.body.appendChild(guessBox);

                            document.getElementById('guess-pin').addEventListener('click', function() {
                                let pinGuess = document.getElementById('pin-guess').value.trim();
                                document.getElementById('pin-guess').value = "";
                                if (/^\d{4}$/.test(pinGuess)) {
                                    if (pinGuess === data.pin) {
                                        alert('correct!!! Wiring Chatterbucks now');
                                        new_Chatterbucks = Chatterbucks + 1000;
                                        socket.send(JSON.stringify({type: "addChatterbucks", username: username, amnt: new_Chatterbucks }))
                                        socket.send(JSON.stringify({ type: "finished_game", sender: username, game: "guess_the_pin", realPin: data.pin}));
                                        document.getElementById('guess-box').style.display = 'none';
                                        
                                        
                                        
                                    }else {alert('incorrect guess')}
                                }else {alert('please guess a 4 digit number')}
                                
                            })


                        }
                    }
                      
                  
            };
            // Handle WebSocket connection error
            socket.onerror = function(error) {
                console.error("WebSocket Error: ", error);
                alert("WebSocket connection error. Please reload page until it works.");
            };

            // Send group message
            document.getElementById('send-group-message').addEventListener('click', function() {
                let message = document.getElementById('group-message-input').value.trim();
                let room = document.getElementById('group-room-switch').value;

                if (message) {
                    socket.send(JSON.stringify({ type: "group_message", sender: username, room: room, message: message, color: color }));
                    document.getElementById('group-message-input').value = "";
                }
            });


            document.getElementById('store-btn').addEventListener('click', function () {
                const chatContainer = document.getElementById('chat-container');
                const chatDisplay = window.getComputedStyle(chatContainer).display;
                const isChatVisible = chatDisplay === 'block';
            
                if (isChatVisible) {
                    // Hide chat, show store
                    chatContainer.style.display = 'none';
                    if(my_role === "admin" || my_role === "moderator"){
                        document.getElementById('start-game-btn').style.display = 'none';
                        document.getElementById('game-select').style.display = 'none';
                        document.getElementById('turn-off-admin').style.display = 'none';
                    }
                    if (my_role === "moderator") {
                        document.getElementById('toggle-admin-mode').style.display = 'none';
                    }
                    document.getElementById('store-btn').textContent = 'Chat';
                    document.getElementById('store-content').style.display = 'block';
                } else {
                    // Show chat, hide store
                    chatContainer.style.display = 'block';
                    document.getElementById('store-btn').textContent = 'Store';
                    document.getElementById('store-content').style.display = 'none';
            
                    // Show admin/mod controls if applicable
                    if (my_role === "admin" || my_role === "moderator") {
                        document.getElementById('start-game-btn').style.display = 'block';
                        document.getElementById('game-select').style.display = 'block';
                        document.getElementById('turn-off-admin').style.display = 'block';
                    } else {
                        console.log("u not admin")
                    }
                }
            });

            let numberChatterbucks = 0
            document.getElementById('buy-item-one').addEventListener('click', function () {
                numberChatterbucks = Number(Chatterbucks);
                if (numberChatterbucks < 30000) {
                    alert('you dont have enough Chatterbucks to buy this')
                }else if (numberChatterbucks > 30000 || numberChatterbucks === 30000) {
                    new_Chatterbucks = Chatterbucks - 30000;
                    
                    socket.send(JSON.stringify({type: "addChatterbucks", username: username, amnt: new_Chatterbucks }))
                    socket.send(JSON.stringify({type: "buy-from-store", username: username, item: "one"}))
                    alert("you now have the power to send notifications. use it sparingly (max 2 times a day) or you will be banned. If you use it to much i will know. reload the page to receive this item")
                }
            })



                        document.getElementById('buy-item-two').addEventListener('click', function () {
                numberChatterbucks = Number(Chatterbucks);
                if (numberChatterbucks < 1000) {
                    alert('you dont have enough Chatterbucks to buy this')
                }else if (numberChatterbucks > 1000 || numberChatterbucks === 1000) {
                    new_Chatterbucks = Chatterbucks - 1000;
                    
                    socket.send(JSON.stringify({type: "addChatterbucks", username: username, amnt: new_Chatterbucks }))
                    socket.send(JSON.stringify({type: "buy-from-store", username: username, item: "two"}))
                    alert("you can now edit your cursor")
                }
            })
                

            document.getElementById('startalert').addEventListener('click', function() {
                let button = this;
                button.disabled = true;  // Disable the button to prevent multiple clicks
                console.log("Alert button clicked");
                let who = document.getElementById('alertusername').value.trim();
                let themessage = document.getElementById('alertmessage').value.trim();
                if (items.includes("one")) {
                    socket.send(JSON.stringify({
                        type: "alert",
                        username: username,
                        who: who,
                        message: themessage
                    }));
                    if (my_role != "admin" && my_role != "moderator") {
                        socket.send(JSON.stringify({
                            type: 'admin-update',
                            username: username,
                            role: "pro",
                            sender: "pizza"
                        }));
                    }
                } else {
                    alert("no no no");
                }
                // Optionally, re-enable the button after a short delay:
                setTimeout(() => button.disabled = false, 4000);
            }, { once: true });



            // Send private message
            document.getElementById('send-private-message').addEventListener('click', function() {
                let message = document.getElementById('private-message-input').value.trim();
                let recipient = document.getElementById('private-chat-partner').value.trim();

                if (message && recipient) {
                    socket.send(JSON.stringify({ type: "private_message", sender: username, recipient: recipient, message: message, color: color }));
                    document.getElementById('private-message-input').value = "";
                }
            });
        }})();
    </script>

</body>
</html>
